\section{Exercise 2}

\begin{lstlisting}[language=sql, caption=Create database]
USE master;
GO

CREATE DATABASE HotelManagementDB;
GO


USE HotelManagementDB;
GO

CREATE TABLE Hotel(
    hotelNo VARCHAR(10) PRIMARY KEY,
    hotelName NVARCHAR(100),
    city NVARCHAR(50),
);
GO


CREATE TABLE Room(
    roomNo VARCHAR(10),
    hotelNo VARCHAR(10),
    type VARCHAR(20),
    price DECIMAL(18,2),
    NumAdultMax INT,
    PRIMARY KEY (roomNo, hotelNo),
    FOREIGN KEY(hotelNo) REFERENCES Hotel(hotelNo)
);
GO

CREATE TABLE Guest(
    guestNo VARCHAR(10) PRIMARY KEY,
    guestName NVARCHAR(100),
    guestAddress NVARCHAR(200),
    TotalAmount DECIMAL(18,2) DEFAULT 0
);
GO

CREATE TABLE Booking(
    hotelNo VARCHAR(10),
    dateFrom DATE,
    roomNo VARCHAR(10),
    guestNo VARCHAR(10),
    dateTo DATE,
    NumOfAdult INT,
    PRIMARY KEY (hotelNo, dateFrom, roomNo),
    FOREIGN KEY (roomNo, hotelNo) REFERENCES Room(roomNo, hotelNo),
    FOREIGN KEY (guestNo) REFERENCES Guest(guestNo)
);
GO
\end{lstlisting}


\subsection{2a}
\begin{lstlisting}[language=sql, caption=Create database]
ALTER TABLE Room 
ADD CONSTRAINT CHK_DoubleRoomPrice
CHECK ((type = 'Double' AND price > 100) OR type <> 'Double')
GO

\end{lstlisting}




\subsection{2b}
\begin{lstlisting}[language=sql, caption=Create database]
CREATE TRIGGER trg_CheckDoublePriceVsSingle
on Room
after INSERT, UPDATE
AS
BEGIN
    IF exists (
        SELECT 1
        FROM inserted i
        JOIN Room r ON i.hotelNo = r.hotelNo
        WHERE i.type = 'Double'
        AND r.type = 'Single'
        AND i.price <= r.price
    )
    BEGIN
        RAISERROR("Error: Double Price greater than Single Price", 16, 1);
        ROLLBACK TRANSACTION;
    END
END;
GO
\end{lstlisting}




\subsection{2c}
\begin{lstlisting}[language=sql, caption=Create database]
CREATE TRIGGER trg_CheckGuessOverlap
ON Booking
after UPDATE, INSERT
AS 
BEGIN
    IF EXISTS(
        SELECT 1
        FROM inserted i
        JOIN Booking b ON i.guestNo = b.guestNo
        WHERE
            NOT (i.hotelNo = b.hotelNo AND i.roomNo = b.roomNo AND i.dateFrom = b.dateFrom)
            AND (i.dateFrom < b.dateTo AND i.dateTo > b.dateFrom)
    )
    BEGIN
        RAISERROR('Error: Overlap time customers', 16, 1);
        ROLLBACK TRANSACTION;
    END
END;
Go
\end{lstlisting}



\subsection{2d}
\begin{lstlisting}[language=sql, caption=Create database]
CREATE TRIGGER trg_CheckMaxAdults
ON Booking
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS(
        SELECT 1
        from inserted i 
        JOIN Room r on i.hotelNo = r.hotelNo and i.roomNo = r.roomNo
        WHERE i.NumOfAdult > r.NumAdultMax
    )
    BEGIN
        RAISERROR('Error: Num of Adult greater than max capacity', 16, 1);
        ROLLBACK TRANSACTION;
    END
END;
GO
\end{lstlisting}


\subsection{2e}
\begin{lstlisting}[language=sql, caption=Create database]

\end{lstlisting}




\subsection{2f}
\begin{lstlisting}[language=sql, caption=Create database]
CREATE TRIGGER trg_InsertLondonHotelRoom
ON LondonHotelRoom
INSTEAD OF INSERT
AS
BEGIN
    set NOCOUNT ON;

    insert into Hotel(hotelNo, hotelName, city)
    SELECT distinct i.hotelNo, i.hotelName, i.city 
    From inserted i 
    WHERE not exists (select 1 from Hotel h where h.hotelNo = i.hotelNo);


    INSERT into Room(roomNo, hotelNo, type, price, NumAdultMax)
    SELECT i.roomNo, i.hotelNo, i.type, i.price, NULL 
    FROM inserted i;
END;
GO
\end{lstlisting}